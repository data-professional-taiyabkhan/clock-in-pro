[phases.setup]
nixPkgs = [
  "nodejs_20",
  "python311",
  "python311Packages.pip",
  "bash",
  "coreutils"
]
aptPkgs = [
  "libstdc++6",
  "libgl1",
  "libglib2.0-0",
  "libsm6",
  "libxext6",
  "libxrender1"
]

# Disable Caddy phase - we use Express to serve the app
[phases.caddy]
cmds = []

[phases.install]
cmds = [
  "npm install --legacy-peer-deps"
]

[phases.build]
cmds = [
  "python3 -m venv --copies /app/.venv",
  "/app/.venv/bin/pip install --no-cache-dir --upgrade pip",
  "/app/.venv/bin/pip install --no-cache-dir -r python-requirements.txt",
  "/app/.venv/bin/python3 -c 'import deepface; print(\"DeepFace successfully installed and imported\")'",
  "npm run build"
]

[start]
cmd = "npm start"

[variables]
PYTHON_KEYRING_BACKEND = "keyring.backends.null.Keyring"
PYTHONUNBUFFERED = "1"
PATH = "/app/.venv/bin:$PATH"
